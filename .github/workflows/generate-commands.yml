name: generate-commands-json

on:
  workflow_dispatch:
    inputs:
      di2se_url:
        description: "URL to di2se tar.gz"
        required: true
        default: "https://builds.steffenl.com/download/dead-island-2-save-editor/0.10.0/di2se-0.10.0-linux.x86_64.tar.gz"
      max_depth:
        description: "Max recursion depth for help crawl"
        required: true
        default: "8"

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Download + extract di2save (nested tar)
        shell: bash
        run: |
          set -euo pipefail

          curl -fsSL "${{ inputs.di2se_url }}" -o di2se.tar.gz
          mkdir -p unpack

          # 1) Extract .tar.gz (may create subdirs)
          tar -xzf di2se.tar.gz -C unpack

          # 2) Find the inner .tar anywhere under unpack
          INNER_TAR="$(find unpack -type f -name '*.tar' | head -n 1 || true)"
          if [ -z "$INNER_TAR" ]; then
            echo "ERROR: Could not find inner .tar under unpack/"
            echo "Contents:"
            find unpack -maxdepth 6 -print
            exit 1
          fi
          echo "Inner tar: $INNER_TAR"

          # 3) Extract inner .tar -> should produce di2se-... directory with bin/di2save and data/
          tar -xf "$INNER_TAR" -C unpack

          # 4) Locate di2se root by finding bin/di2save
          DI2SE_ROOT="$(find unpack -type f -path '*/bin/di2save' -print | head -n 1 | xargs -r dirname | xargs -r dirname || true)"
          if [ -z "$DI2SE_ROOT" ]; then
            echo "ERROR: Could not find bin/di2save after extracting inner tar."
            echo "Contents:"
            find unpack -maxdepth 8 -print
            exit 1
          fi

          echo "DI2SE_ROOT=$DI2SE_ROOT" | tee -a "$GITHUB_ENV"
          chmod +x "$DI2SE_ROOT/bin/di2save"

          # Sanity check: run help from root so ./data is available
          (cd "$DI2SE_ROOT" && ./bin/di2save --help | head -n 30)

      - name: Generate commands.json
        shell: bash
        env:
          DI2SE_ROOT: ${{ env.DI2SE_ROOT }}
          DI2SAVE_REL: bin/di2save
          OUT_FILE: commands.json
          MAX_DEPTH: ${{ inputs.max_depth }}
        run: |
          set -euo pipefail
          python tools/generate_commands.py
          head -n 20 commands.json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: commands-json
          path: commands.json
