name: generate-commands-json

on:
  workflow_dispatch:
    inputs:
      di2se_url:
        description: "URL to di2se tar.gz"
        required: true
        default: "https://builds.steffenl.com/download/dead-island-2-save-editor/0.10.0/di2se-0.10.0-linux.x86_64.tar.gz"
      max_depth:
        description: "Max recursion depth for help crawl"
        required: true
        default: "10"

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Download + extract di2save
        shell: bash
        run: |
          set -euo pipefail

          curl -fsSL "${{ inputs.di2se_url }}" -o di2se.tar.gz
          mkdir -p unpack

          tar -xzf di2se.tar.gz -C unpack

          DI2SE_EXE="$(find unpack -type f -path '*/bin/di2save' -print | head -n 1)"
          if [ -z "$DI2SE_EXE" ]; then
            echo "ERROR: bin/di2save not found after extraction"
            find unpack -maxdepth 6 -print
            exit 1
          fi

          DI2SE_ROOT="$(dirname "$(dirname "$DI2SE_EXE")")"
          echo "DI2SE_ROOT=$DI2SE_ROOT" | tee -a "$GITHUB_ENV"

          chmod +x "$DI2SE_ROOT/bin/di2save"

          echo "Sanity check:"
          (cd "$DI2SE_ROOT/bin" && ./di2save --help | head -n 30)

      - name: Generate commands.json (seeded discovery)
        shell: bash
        env:
          DI2SE_ROOT: ${{ env.DI2SE_ROOT }}
          OUT_FILE: commands.json
          MAX_DEPTH: ${{ inputs.max_depth }}
          # Seeds you requested:
          HELP_SEEDS: |
            --help
            --help player
            --help file
            --help stash
            --help quick
            help inventory items
            help inventory upgrades
        run: |
          set -euo pipefail
          python tools/generate_commands.py
          head -n 20 commands.json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: commands-json
          path: commands.json
